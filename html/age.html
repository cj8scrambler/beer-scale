<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fulton Beer Status</title>
</head>

<body onload="getKegState();">

<center><h2>Datapoint Ages</h2></center>

<center><p id="beerstatus"></p></center>

<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<script>
length = "days=12"
tapname = "LeftFridgeLeftTap";
group = "TestData";
apiUrl = "https://b67qghztgl.execute-api.us-west-2.amazonaws.com/dev/";
function getKegState(sel) {
  var xmlhttp, myObj, x, txt = "";

//  console.log("DZ: gonna graph");
  var options = {
    chart: {
      renderTo: 'container',
      type: 'spline',
      zoomType: 'x',
    },
    title: {
      text: 'Tap History'
    },
    xAxis: {
      type: 'datetime',
    },
    yAxis: {
      title: {
        text: 'Weight (g)'
      },
    },
    plotOptions: {
        spline: {
            marker: {
                enabled: false,
            }
        }
    },
    tooltip: {
      headerFormat: '<b>{series.name}</b><br>',
      pointFormat: '{point.x:%e. %b}: {point.y:.2f} m'
        },
    colors: ['#6CF', '#39F', '#06C', '#036', '#000'],
    series: []
  };

  console.log("DZ: options:", options);
  var url =  apiUrl + group + "/" + tapname + "/history/?age=0&" + length;
  jQuery.getJSON(url,  function(data) {
//    console.log("DZ: age 0 length:", data.length);
    if (data.length) {
//        console.log("DZ: got age 0 data:", data);
        options.series.push({ data: data, name: "Age 0", });
    }

    var url =  apiUrl + group + "/" + tapname + "/history/?age=2&" + length;
    jQuery.getJSON(url,  function(data) {
      if (data.length) {
//          console.log("DZ: got age 2 data:", data);
          options.series.push({ data: data, name: "Age 2", });
      }

      var url =  apiUrl + group + "/" + tapname + "/history/?age=4&" + length;
      jQuery.getJSON(url,  function(data) {
        if (data.length) {
//            console.log("DZ: got age 4 data:", data);
            options.series.push({ data: data, name: "Age 4", });
        }

        var url =  apiUrl + group + "/" + tapname + "/history/?age=8&" + length;
        jQuery.getJSON(url,  function(data) {
          if (data.length) {
//              console.log("DZ: got age 8 data:", data);
              options.series.push({ data: data, name: "Age 8", });
          }

          var url =  apiUrl + group + "/" + tapname + "/history/?age=16&" + length;
          jQuery.getJSON(url,  function(data) {
            if (data.length) {
//                console.log("DZ: got age 16 data:", data);
                options.series.push({ data: data, name: "Age 16", });
            }

            var url =  apiUrl + group + "/" + tapname + "/history/?age=32&" + length;
            jQuery.getJSON(url,  function(data) {
              if (data.length) {
//                  console.log("DZ: got age 32 data:", data);
                  options.series.push({ data: data, name: "Age 32", });
              }

              var url =  apiUrl + group + "/" + tapname + "/history/?age=64&" + length;
              jQuery.getJSON(url,  function(data) {
                if (data.length) {
//                    console.log("DZ: got age 64 data:", data);
                    options.series.push({ data: data, name: "Age 64", });
                }
  
                Highcharts.setOptions({
                  global: {
                    useUTC: false,
                  }
                });
                var chart = new Highcharts.Chart(options);
              });
            });
          });
        });
      });
    });
  });
}
</script>
</body>
</html>
