<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fulton Beer Status</title>
</head>

<body onload="getKegState();">

<center><h2>ORD Beer Info</h2></center>

<center><p id="beerstatus"></p></center>

<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<script>
length = "days=14"
tapname = "LeftFridgeLeftTap";
group = "FultonKitchen";
apiUrl = "https://b67qghztgl.execute-api.us-west-2.amazonaws.com/dev/";
function getKegState(sel) {
  var xmlhttp, myObj, x, txt = "";

  fetch(apiUrl + group)
    .then(function(response){
        return response.json();
    })
    .then(function(json){
      txt += "<table border='0' cellspacing='10'>";
      txt += "<tr><th>Tap</th>";
      txt += "    <th>Beer</th>";
      txt += "    <th>Style</th>";
      txt += "    <th>Brewery</th>";
      txt += "    <th>ABV</th>";
      txt += "    <th>IBU</th>";
      txt += "    <th>Color</th>";
      txt += "    <th>Keg Weight</th>";
      txt += "    <th>Last Update</th></tr>";
      for (x in json.results) {
        var tap = json.results[x];
        var lastUpdate = new Date(tap['timestamp']*1000);
        txt += "<tr><td>" + tap['tap'] + "</td>";
        txt += "<td>" + tap['beername'] + "</td>";
        txt += "<td>" + tap['style'] + "</td>";
        txt += "<td>" + tap['brewer'] + "(" + tap['brewerlocation'] + ")</td>";
        txt += "<td>" + tap['abv'] + "%</td>";
        txt += "<td>" + (('ibu' in tap) ? tap['ibu'] : "") + "</td>";
        txt += "<td>" + (('color' in tap) ? (tap['color'] + " SRM") : "") + "</td>";
        txt += "<td>" + tap['weight'].toString() + "</td>";
        txt += "<td>" + lastUpdate + "</td></tr>";
      }
      txt += "</table>"
      document.getElementById("beerstatus").innerHTML = txt;

      console.log("DZ: gonna graph");
      var options = {
        chart: {
          renderTo: 'container',
          type: 'spline'
        },
        title: {
          text: 'Tap History'
        },
        xAxis: {
          type: 'datetime',
        },
        yAxis: {
          title: {
            text: 'Weight (g)'
          },
        },
        tooltip: {
          headerFormat: '<b>{series.name}</b><br>',
          pointFormat: '{point.x:%e. %b}: {point.y:.2f} m'
        },
        colors: ['#6CF', '#39F', '#06C', '#036', '#000'],
        series: [{}]
      };

      console.log("DZ: options:", options);
      var url =  apiUrl + group + "/" + tapname + "/history/?" + length;
      console.log("DZ: fetching: ", url);
      jQuery.getJSON(url,  function(data) {
        console.log("DZ: got tap data:", data);
        options.series[0].data = data;
        options.series[0].name = tapname;
        console.log("DZ: generating chart...");
        var chart = new Highcharts.Chart(options);
      });
    })
    .catch(function(error) {
      console.log("problem:", error);
    });   
}
</script>
</body>
</html>
